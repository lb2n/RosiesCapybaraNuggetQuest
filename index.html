<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capybara Nugget Quest üß°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg,
                #FFB3BA 0%,      /* pastel pink */
                #FFDFBA 14%,     /* pastel orange */
                #FFFFBA 28%,     /* pastel yellow */
                #BAFFC9 42%,     /* pastel green */
                #BAE1FF 56%,     /* pastel blue */
                #D4BAFF 70%,     /* pastel purple */
                #FFBAF3 85%,     /* pastel magenta */
                #FFB3BA 100%     /* back to pink */
            );
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        h1 {
            color: #8B4513;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }

        .subtitle {
            color: #D2691E;
            font-size: 1.2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-info {
            display: flex;
            gap: 30px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .info-box {
            background: rgba(255,255,255,0.9);
            padding: 10px 25px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 1.3em;
            color: #8B4513;
        }

        .game-container {
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            position: relative;
        }

        .game-board {
            display: grid;
            gap: 8px;
            padding: 10px;
            background: linear-gradient(145deg, #FFF8DC, #FAEBD7);
            border-radius: 20px;
        }

        .cell {
            width: 70px;
            height: 70px;
            background: linear-gradient(145deg, #FFFAF0, #FFF5EE);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .cell:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .cell.selected {
            background: linear-gradient(145deg, #FFE4B5, #FFDAB9);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255,165,0,0.5);
        }

        .cell.matched {
            animation: matchPop 0.5s ease;
        }

        .cell.hint {
            animation: hintPulse 1s ease infinite;
        }

        @keyframes matchPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; }
        }

        @keyframes hintPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 0 25px rgba(255,215,0,0.9); }
        }

        .capybara-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 80px;
            animation: float 3s ease-in-out infinite;
            z-index: 100;
        }

        .capybara-speech {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 16px;
            color: #8B4513;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .capybara-speech.show {
            opacity: 1;
        }

        .capybara-speech::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 30px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: white transparent transparent;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .new-game-btn {
            background: linear-gradient(145deg, #90EE90, #3CB371);
            color: white;
        }

        .hint-btn {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: white;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 15px;
            height: 15px;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .level-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #FFE4B5, #FFDAB9);
            padding: 40px 60px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
        }

        .level-complete h2 {
            color: #8B4513;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .level-complete p {
            color: #D2691E;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .level-complete .emoji-celebration {
            font-size: 3em;
            margin-bottom: 20px;
        }

        /* Dancing capybara celebration */
        .dancing-capybara {
            font-size: 5em;
            display: inline-block;
            animation: capybaraDance 0.5s ease-in-out infinite;
            margin: 10px;
        }

        .dancing-capybara:nth-child(2) {
            animation-delay: 0.1s;
        }

        .dancing-capybara:nth-child(3) {
            animation-delay: 0.2s;
        }

        @keyframes capybaraDance {
            0%, 100% {
                transform: translateY(0) rotate(-10deg) scale(1);
            }
            25% {
                transform: translateY(-20px) rotate(10deg) scale(1.1);
            }
            50% {
                transform: translateY(0) rotate(-10deg) scale(1);
            }
            75% {
                transform: translateY(-15px) rotate(15deg) scale(1.05);
            }
        }

        .dance-floor {
            margin: 15px 0;
            padding: 10px;
            background: linear-gradient(90deg, #FFB3BA, #FFDFBA, #FFFFBA, #BAFFC9, #BAE1FF, #D4BAFF);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .sparkles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .sparkle {
            position: absolute;
            font-size: 1.5em;
            animation: sparkleFloat 1.5s ease-in-out infinite;
        }

        @keyframes sparkleFloat {
            0%, 100% {
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }
        }

        .stars {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .difficulty-select {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .diff-btn {
            padding: 8px 20px;
            font-size: 1em;
            border-radius: 20px;
            background: rgba(255,255,255,0.7);
            color: #8B4513;
            border: 2px solid transparent;
        }

        .diff-btn.active {
            background: linear-gradient(145deg, #FFB347, #FF8C00);
            color: white;
            border-color: #8B4513;
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: #FF6347;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
        }

        .combo-display.show {
            animation: comboPopup 1s ease forwards;
        }

        @keyframes comboPopup {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -70%) scale(0.8); opacity: 0; }
        }

        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .sound-toggle:hover {
            transform: scale(1.1);
        }

        .nugget-counter {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nugget-icon {
            font-size: 1.5em;
        }

        @media (max-width: 600px) {
            .cell {
                width: 55px;
                height: 55px;
                font-size: 30px;
            }

            h1 {
                font-size: 1.8em;
            }

            .capybara-container {
                font-size: 50px;
                bottom: 10px;
                right: 10px;
            }
        }

        /* Custom chicken nugget styling */
        .nugget-svg {
            width: 40px;
            height: 40px;
        }

        .bow {
            filter: brightness(1.1) saturate(1.3);
        }

        @media (max-width: 600px) {
            .nugget-svg {
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body>
    <h1>üß° Capybara Nugget Quest üß°</h1>
    <p class="subtitle">Help the capybaras collect yummy chicken nuggets!</p>

    <div class="difficulty-select">
        <button class="diff-btn active" data-size="5">Easy (5√ó5)</button>
        <button class="diff-btn" data-size="6">Medium (6√ó6)</button>
        <button class="diff-btn" data-size="7">Tricky (7√ó7)</button>
    </div>

    <div class="game-info">
        <div class="info-box">‚≠ê Score: <span id="score">0</span></div>
        <div class="info-box">üéØ Level: <span id="level">1</span></div>
        <div class="info-box nugget-counter">
            <span class="nugget-icon"><svg style="width:24px;height:20px;vertical-align:middle" viewBox="0 0 100 80"><path d="M15,45 Q10,30 25,20 Q40,10 60,15 Q80,18 90,35 Q95,50 85,60 Q70,72 50,70 Q25,68 15,55 Z" fill="#B8860B"/><ellipse cx="45" cy="40" rx="20" ry="15" fill="#DAA520"/><circle cx="30" cy="35" r="4" fill="#8B4513" opacity="0.5"/><circle cx="60" cy="45" r="3" fill="#8B4513" opacity="0.5"/></svg></span>
            <span id="nuggets">0</span> / <span id="nugget-goal">10</span>
        </div>
    </div>

    <div class="game-container">
        <div class="game-board" id="board"></div>
        <div class="combo-display" id="combo"></div>
    </div>

    <div class="buttons">
        <button class="hint-btn" id="hint-btn">üí° Hint</button>
        <button class="new-game-btn" id="new-game-btn">üåü New Game</button>
    </div>

    <div class="capybara-container">
        ü¶´
        <div class="capybara-speech" id="speech">Welcome, friend!</div>
    </div>

    <div class="celebration" id="celebration"></div>

    <div class="level-complete" id="level-complete">
        <div class="sparkles" id="sparkles"></div>
        <h2>üéâ Level Complete! üéâ</h2>
        <div class="dance-floor">
            <span class="dancing-capybara">ü¶´</span>
            <span class="dancing-capybara">ü¶´</span>
            <span class="dancing-capybara">ü¶´</span>
        </div>
        <div class="stars" id="stars">‚≠ê‚≠ê‚≠ê</div>
        <p id="level-message">Amazing job!</p>
        <button class="new-game-btn" id="next-level-btn">Next Level ‚Üí</button>
    </div>

    <div class="sound-toggle" id="sound-toggle">üîä</div>

    <script>
        // Game state
        let board = [];
        let boardSize = 5;
        let selected = null;
        let score = 0;
        let level = 1;
        let nuggets = 0;
        let nuggetGoal = 10;
        let combo = 0;
        let soundEnabled = true;
        let isAnimating = false;

        // Game pieces - capybaras, nuggets, and bows!
        const pieces = ['ü¶´', 'üü§', 'ü•§', 'ü•¨', 'üéÄ', 'üå∏'];

        // Custom nugget rendering
        const pieceDisplay = {
            'üü§': '<span class="nugget">üü°</span>', // chicken nugget
            'üéÄ': '<span class="bow">üéÄ</span>'     // pink bow
        };

        // Capybara messages
        const messages = {
            match: [
                "Yay! Nuggets!",
                "Delicious!",
                "Om nom nom!",
                "So yummy!",
                "More nuggets!",
                "Wonderful!",
                "You're amazing!",
                "Keep going!",
                "Tasty treats!",
                "Love the bows! üéÄ"
            ],
            combo: [
                "WOW! Combo!",
                "SUPER match!",
                "You're on fire!",
                "Incredible!",
                "Nugget party!"
            ],
            hint: [
                "Look here!",
                "Try this one!",
                "I see one!",
                "Over here!"
            ],
            levelUp: [
                "Level up! üåü",
                "You did it!",
                "Amazing work!",
                "So proud of you!"
            ],
            idle: [
                "Take your time~",
                "No rush!",
                "*happy capybara*",
                "üß°",
                "You got this!",
                "*relaxing*"
            ]
        };

        // Audio context for sounds
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!soundEnabled || !audioCtx) return;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            switch(type) {
                case 'select':
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialDecayTo = 0.01;
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    break;
                case 'match':
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.1); // G5
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.2);
                    break;
                case 'combo':
                    const notes = [523.25, 659.25, 783.99, 1046.50];
                    notes.forEach((note, i) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.frequency.setValueAtTime(note, audioCtx.currentTime + i * 0.1);
                        osc.type = 'sine';
                        gain.gain.setValueAtTime(0.1, audioCtx.currentTime + i * 0.1);
                        osc.start(audioCtx.currentTime + i * 0.1);
                        osc.stop(audioCtx.currentTime + i * 0.1 + 0.15);
                    });
                    break;
                case 'levelup':
                    const melody = [523.25, 659.25, 783.99, 1046.50, 1318.51];
                    melody.forEach((note, i) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.frequency.setValueAtTime(note, audioCtx.currentTime + i * 0.15);
                        osc.type = 'triangle';
                        gain.gain.setValueAtTime(0.15, audioCtx.currentTime + i * 0.15);
                        osc.start(audioCtx.currentTime + i * 0.15);
                        osc.stop(audioCtx.currentTime + i * 0.15 + 0.2);
                    });
                    break;
            }
        }

        function showMessage(category) {
            const msgs = messages[category];
            const msg = msgs[Math.floor(Math.random() * msgs.length)];
            const speech = document.getElementById('speech');
            speech.textContent = msg;
            speech.classList.add('show');
            setTimeout(() => speech.classList.remove('show'), 2000);
        }

        function createBoard() {
            board = [];
            for (let i = 0; i < boardSize; i++) {
                board[i] = [];
                for (let j = 0; j < boardSize; j++) {
                    board[i][j] = getRandomPiece();
                }
            }

            // Ensure no initial matches
            while (findMatches().length > 0) {
                for (let match of findMatches()) {
                    board[match.row][match.col] = getRandomPiece();
                }
            }

            // Ensure at least one valid move
            while (!hasValidMove()) {
                shuffleBoard();
            }

            renderBoard();
        }

        function getRandomPiece() {
            return pieces[Math.floor(Math.random() * pieces.length)];
        }

        // SVG for chicken nugget - crispy golden brown fried nugget
        const nuggetSVG = `<svg class="nugget-svg" viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg">
            <!-- Main nugget shape - irregular like a real nugget -->
            <path d="M15,45 Q10,30 25,20 Q40,10 60,15 Q80,18 90,35 Q95,50 85,60 Q70,72 50,70 Q25,68 15,55 Z" fill="#B8860B"/>
            <!-- Darker crispy edges -->
            <path d="M15,45 Q10,30 25,20 Q40,10 60,15 Q80,18 90,35 Q95,50 85,60 Q70,72 50,70 Q25,68 15,55 Z" fill="#8B6914" opacity="0.4"/>
            <!-- Breading texture - bumpy surface -->
            <ellipse cx="35" cy="35" rx="18" ry="14" fill="#CD950C"/>
            <ellipse cx="60" cy="40" rx="20" ry="16" fill="#DAA520"/>
            <ellipse cx="45" cy="50" rx="15" ry="12" fill="#CD950C"/>
            <!-- Golden highlights -->
            <ellipse cx="40" cy="30" rx="10" ry="7" fill="#E8A317" opacity="0.7"/>
            <ellipse cx="65" cy="35" rx="8" ry="5" fill="#E8A317" opacity="0.6"/>
            <!-- Crispy dark spots (fried bits) -->
            <circle cx="25" cy="40" r="4" fill="#8B4513" opacity="0.5"/>
            <circle cx="70" cy="50" r="5" fill="#8B4513" opacity="0.4"/>
            <circle cx="50" cy="28" r="3" fill="#8B4513" opacity="0.5"/>
            <circle cx="38" cy="55" r="4" fill="#8B4513" opacity="0.4"/>
            <circle cx="75" cy="35" r="3" fill="#8B4513" opacity="0.5"/>
            <circle cx="30" cy="25" r="2" fill="#8B4513" opacity="0.4"/>
            <circle cx="60" cy="58" r="3" fill="#8B4513" opacity="0.5"/>
            <!-- Subtle shine -->
            <ellipse cx="45" cy="25" rx="6" ry="3" fill="#FFD700" opacity="0.3"/>
        </svg>`;

        function renderBoard() {
            const boardEl = document.getElementById('board');
            boardEl.style.gridTemplateColumns = `repeat(${boardSize}, 1fr)`;
            boardEl.innerHTML = '';

            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';

                    // Check if it's a nugget piece
                    if (board[i][j] === 'üü§') {
                        cell.innerHTML = nuggetSVG;
                    } else {
                        cell.textContent = board[i][j];
                    }

                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.addEventListener('click', () => handleClick(i, j));
                    boardEl.appendChild(cell);
                }
            }
        }

        function handleClick(row, col) {
            if (isAnimating) return;

            initAudio();
            playSound('select');

            const cells = document.querySelectorAll('.cell');

            if (selected === null) {
                selected = { row, col };
                cells[row * boardSize + col].classList.add('selected');
            } else {
                const prevCell = cells[selected.row * boardSize + selected.col];
                prevCell.classList.remove('selected');

                // Check if adjacent
                const rowDiff = Math.abs(row - selected.row);
                const colDiff = Math.abs(col - selected.col);

                if ((rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1)) {
                    // Swap and check for matches
                    swap(selected.row, selected.col, row, col);

                    const matches = findMatches();
                    if (matches.length > 0) {
                        isAnimating = true;
                        combo = 0;
                        processMatches();
                    } else {
                        // Swap back
                        swap(selected.row, selected.col, row, col);
                        renderBoard();
                    }
                }

                selected = null;
            }
        }

        function swap(r1, c1, r2, c2) {
            const temp = board[r1][c1];
            board[r1][c1] = board[r2][c2];
            board[r2][c2] = temp;
            renderBoard();
        }

        function findMatches() {
            const matches = [];

            // Horizontal matches
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize - 2; j++) {
                    if (board[i][j] && board[i][j] === board[i][j+1] && board[i][j] === board[i][j+2]) {
                        matches.push({ row: i, col: j });
                        matches.push({ row: i, col: j+1 });
                        matches.push({ row: i, col: j+2 });
                    }
                }
            }

            // Vertical matches
            for (let i = 0; i < boardSize - 2; i++) {
                for (let j = 0; j < boardSize; j++) {
                    if (board[i][j] && board[i][j] === board[i+1][j] && board[i][j] === board[i+2][j]) {
                        matches.push({ row: i, col: j });
                        matches.push({ row: i+1, col: j });
                        matches.push({ row: i+2, col: j });
                    }
                }
            }

            // Remove duplicates
            const unique = [];
            const seen = new Set();
            for (const m of matches) {
                const key = `${m.row},${m.col}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(m);
                }
            }

            return unique;
        }

        function processMatches() {
            const matches = findMatches();

            if (matches.length === 0) {
                isAnimating = false;

                // Check for valid moves
                if (!hasValidMove()) {
                    showMessage('idle');
                    shuffleBoard();
                }

                // Check level completion
                if (nuggets >= nuggetGoal) {
                    completeLevel();
                }
                return;
            }

            combo++;
            const points = matches.length * 10 * combo;
            score += points;
            nuggets += Math.ceil(matches.length / 3);

            document.getElementById('score').textContent = score;
            document.getElementById('nuggets').textContent = Math.min(nuggets, nuggetGoal);

            // Show combo
            if (combo > 1) {
                showCombo(combo);
                showMessage('combo');
                playSound('combo');
            } else {
                showMessage('match');
                playSound('match');
            }

            // Animate matches
            const cells = document.querySelectorAll('.cell');
            for (const m of matches) {
                const cell = cells[m.row * boardSize + m.col];
                cell.classList.add('matched');
            }

            setTimeout(() => {
                // Remove matched pieces
                for (const m of matches) {
                    board[m.row][m.col] = null;
                }

                // Drop pieces down
                dropPieces();

                // Fill empty spaces
                fillEmpty();

                renderBoard();

                // Check for more matches
                setTimeout(() => processMatches(), 300);
            }, 400);
        }

        function dropPieces() {
            for (let j = 0; j < boardSize; j++) {
                let emptyRow = boardSize - 1;
                for (let i = boardSize - 1; i >= 0; i--) {
                    if (board[i][j] !== null) {
                        if (i !== emptyRow) {
                            board[emptyRow][j] = board[i][j];
                            board[i][j] = null;
                        }
                        emptyRow--;
                    }
                }
            }
        }

        function fillEmpty() {
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    if (board[i][j] === null) {
                        board[i][j] = getRandomPiece();
                    }
                }
            }
        }

        function hasValidMove() {
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    // Try swap right
                    if (j < boardSize - 1) {
                        swap(i, j, i, j+1);
                        if (findMatches().length > 0) {
                            swap(i, j, i, j+1);
                            return true;
                        }
                        swap(i, j, i, j+1);
                    }
                    // Try swap down
                    if (i < boardSize - 1) {
                        swap(i, j, i+1, j);
                        if (findMatches().length > 0) {
                            swap(i, j, i+1, j);
                            return true;
                        }
                        swap(i, j, i+1, j);
                    }
                }
            }
            return false;
        }

        function findHint() {
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    if (j < boardSize - 1) {
                        swap(i, j, i, j+1);
                        if (findMatches().length > 0) {
                            swap(i, j, i, j+1);
                            return [{ row: i, col: j }, { row: i, col: j+1 }];
                        }
                        swap(i, j, i, j+1);
                    }
                    if (i < boardSize - 1) {
                        swap(i, j, i+1, j);
                        if (findMatches().length > 0) {
                            swap(i, j, i+1, j);
                            return [{ row: i, col: j }, { row: i+1, col: j }];
                        }
                        swap(i, j, i+1, j);
                    }
                }
            }
            return null;
        }

        function showHint() {
            if (isAnimating) return;

            const hint = findHint();
            if (hint) {
                showMessage('hint');
                const cells = document.querySelectorAll('.cell');
                for (const h of hint) {
                    cells[h.row * boardSize + h.col].classList.add('hint');
                }
                setTimeout(() => {
                    document.querySelectorAll('.cell.hint').forEach(c => c.classList.remove('hint'));
                }, 2000);
            }
        }

        function shuffleBoard() {
            const allPieces = board.flat();
            for (let i = allPieces.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allPieces[i], allPieces[j]] = [allPieces[j], allPieces[i]];
            }

            let idx = 0;
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    board[i][j] = allPieces[idx++];
                }
            }

            // Remove any matches created by shuffle
            while (findMatches().length > 0) {
                for (let match of findMatches()) {
                    board[match.row][match.col] = getRandomPiece();
                }
            }

            renderBoard();
        }

        function showCombo(comboNum) {
            const comboEl = document.getElementById('combo');
            comboEl.textContent = `${comboNum}x COMBO! üåü`;
            comboEl.classList.remove('show');
            void comboEl.offsetWidth;
            comboEl.classList.add('show');
        }

        function createConfetti() {
            const celebration = document.getElementById('celebration');
            celebration.innerHTML = '';

            const emojis = ['üéâ', '‚≠ê', 'üéÄ', 'ü¶´', 'üí´', 'üß°', '‚ú®', 'üíñ'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.fontSize = (Math.random() * 20 + 15) + 'px';
                celebration.appendChild(confetti);
            }
        }

        function createSparkles() {
            const sparklesContainer = document.getElementById('sparkles');
            sparklesContainer.innerHTML = '';

            const sparkleEmojis = ['‚ú®', 'üí´', '‚≠ê', 'üåü', 'üíñ', 'üéÄ'];

            for (let i = 0; i < 12; i++) {
                const sparkle = document.createElement('span');
                sparkle.className = 'sparkle';
                sparkle.textContent = sparkleEmojis[Math.floor(Math.random() * sparkleEmojis.length)];
                sparkle.style.left = (10 + Math.random() * 80) + '%';
                sparkle.style.top = (10 + Math.random() * 80) + '%';
                sparkle.style.animationDelay = (Math.random() * 1.5) + 's';
                sparklesContainer.appendChild(sparkle);
            }
        }

        function completeLevel() {
            playSound('levelup');
            createConfetti();
            createSparkles();
            showMessage('levelUp');

            const levelComplete = document.getElementById('level-complete');
            const stars = document.getElementById('stars');
            const levelMessage = document.getElementById('level-message');

            // Calculate stars based on score
            const baseScore = nuggetGoal * 30;
            let starCount = 1;
            if (score > baseScore * 1.5) starCount = 2;
            if (score > baseScore * 2) starCount = 3;

            stars.textContent = '‚≠ê'.repeat(starCount) + '‚òÜ'.repeat(3 - starCount);

            const levelMessages = [
                "Great job, friend!",
                "The capybaras are dancing!",
                "You're a nugget champion!",
                "Amazing work!",
                "The capybaras love you!",
                "Dance party time!"
            ];
            levelMessage.textContent = levelMessages[Math.floor(Math.random() * levelMessages.length)];

            levelComplete.style.display = 'block';
        }

        function nextLevel() {
            level++;
            nuggetGoal = 10 + (level - 1) * 5;
            nuggets = 0;

            document.getElementById('level').textContent = level;
            document.getElementById('nuggets').textContent = 0;
            document.getElementById('nugget-goal').textContent = nuggetGoal;
            document.getElementById('level-complete').style.display = 'none';
            document.getElementById('celebration').innerHTML = '';

            createBoard();
        }

        function newGame() {
            score = 0;
            level = 1;
            nuggets = 0;
            nuggetGoal = 10;
            combo = 0;

            document.getElementById('score').textContent = 0;
            document.getElementById('level').textContent = 1;
            document.getElementById('nuggets').textContent = 0;
            document.getElementById('nugget-goal').textContent = 10;
            document.getElementById('level-complete').style.display = 'none';
            document.getElementById('celebration').innerHTML = '';

            createBoard();
            showMessage('idle');
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-toggle').textContent = soundEnabled ? 'üîä' : 'üîá';
        }

        // Event listeners
        document.getElementById('hint-btn').addEventListener('click', showHint);
        document.getElementById('new-game-btn').addEventListener('click', newGame);
        document.getElementById('next-level-btn').addEventListener('click', nextLevel);
        document.getElementById('sound-toggle').addEventListener('click', () => {
            initAudio();
            toggleSound();
        });

        // Difficulty buttons
        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                boardSize = parseInt(btn.dataset.size);
                newGame();
            });
        });

        // Idle messages
        setInterval(() => {
            if (!isAnimating && Math.random() < 0.3) {
                showMessage('idle');
            }
        }, 10000);

        // Start game
        createBoard();
        setTimeout(() => showMessage('idle'), 1000);
    </script>
</body>
</html>
